<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Keepalived + Mysql双主-容灾配置</title>
    <url>/2023/09/10/Keepalived%20+%20Mysql%E5%8F%8C%E4%B8%BB%20%E5%AE%B9%E7%81%BE/</url>
    <content><![CDATA[<p>1、利用keepalived实现mysql灾备自动切换</p>
<span id="more"></span>

<ul>
<li>mysql的灾备应使用双主结构，主从结构对灾备有一定要求。从节点不能直接升级为主节点，需要确认同步完全、切换配置升级为主。双主结构便可直接漂移ip即可。</li>
<li>Mysql双主搭建流程不再本文描述范围<ul>
<li>基于Docker搭建Mysql双主结构 <a href="https://www.yuque.com/shiyuan-kwttd/bmk7pt/yirz6n">https://www.yuque.com/shiyuan-kwttd/bmk7pt/yirz6n</a></li>
</ul>
</li>
</ul>
<p>2、推荐一台mysql机器搭配一个keepalived防止 keepalived服务挂掉。</p>
<p>本文由于是在单机下部署测试，故使用了一个keepalived服务</p>
<p>1、keepalived配置文件</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"> <span class="string">!</span> <span class="string">Configuration</span> <span class="string">File</span> <span class="string">for</span> <span class="string">keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="string">global_defs</span> &#123;</span><br><span class="line">   <span class="string">router_id</span> <span class="string">dbmaster</span> <span class="string">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定一个keepalived服务实例</span></span><br><span class="line"><span class="string">vrrp_instance</span> <span class="string">VI_1</span> &#123;</span><br><span class="line">    <span class="comment"># 如果多个keepalived实例此处可设置为BACKUP</span></span><br><span class="line">    <span class="string">state</span> <span class="string">MASTER</span></span><br><span class="line">    <span class="string">interface</span> <span class="string">enp4s0f1</span></span><br><span class="line">    <span class="string">virtual_router_id</span> <span class="number">51</span></span><br><span class="line">    <span class="string">priority</span> <span class="number">100</span></span><br><span class="line">    <span class="string">nopreempt</span> <span class="comment"># 此设置代表不抢占, 也就是一台升级为主，</span></span><br><span class="line">    <span class="string">advert_int</span> <span class="number">1</span></span><br><span class="line">    <span class="string">authentication</span> &#123;</span><br><span class="line">        <span class="string">auth_type</span> <span class="string">PASS</span></span><br><span class="line">        <span class="string">auth_pass</span> <span class="number">1111</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">virtual_ipaddress</span> &#123;</span><br><span class="line">        <span class="comment"># 虚拟的ip 比如此处代理的是mysql,代码或程序中则使用此ip</span></span><br><span class="line">        <span class="number">192.168</span><span class="number">.31</span><span class="number">.60</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">virtual_server</span> <span class="number">192.168</span><span class="number">.31</span><span class="number">.60</span> <span class="number">3306</span> &#123;</span><br><span class="line">    <span class="string">delay_loop</span> <span class="number">6</span></span><br><span class="line">    <span class="string">lb_algo</span> <span class="string">rr</span></span><br><span class="line">    <span class="string">lb_kind</span> <span class="string">NAT</span></span><br><span class="line">    <span class="string">persistence_timeout</span> <span class="number">50</span></span><br><span class="line">    <span class="string">protocol</span> <span class="string">TCP</span></span><br><span class="line">    <span class="comment"># mysql 真实ip 端口</span></span><br><span class="line">    <span class="string">real_server</span> <span class="number">192.168</span><span class="number">.31</span><span class="number">.65</span> <span class="number">53306</span> &#123;</span><br><span class="line">        <span class="string">weight</span> <span class="number">1</span></span><br><span class="line">        <span class="string">TCP_CHECK</span> &#123;</span><br><span class="line">            <span class="string">connect_timeout</span> <span class="number">3</span></span><br><span class="line">            <span class="string">retry</span> <span class="number">3</span></span><br><span class="line">            <span class="string">connect_port</span> <span class="number">53306</span></span><br><span class="line">            <span class="string">delay_before_retry</span> <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># mysql 真实ip 端口</span></span><br><span class="line">    <span class="string">real_server</span> <span class="number">192.168</span><span class="number">.31</span><span class="number">.65</span> <span class="number">53406</span> &#123;</span><br><span class="line">        <span class="string">weight</span> <span class="number">1</span></span><br><span class="line">        <span class="string">TCP_CHECK</span> &#123;</span><br><span class="line">            <span class="string">connect_timeout</span> <span class="number">3</span></span><br><span class="line">            <span class="string">retry</span> <span class="number">3</span></span><br><span class="line">            <span class="string">connect_port</span> <span class="number">53406</span></span><br><span class="line">            <span class="string">delay_before_retry</span> <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>博客</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker安装Skywalking</title>
    <url>/2023/09/16/Skywalking%20%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h3 id="docker-compose配置"><a href="#docker-compose配置" class="headerlink" title="docker-compose配置"></a>docker-compose配置</h3><span id="more"></span>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">skywalking-oap:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/skywalking-oap-server:9.0.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">skywalking-oap</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/docker/skywalking/alarm-settings.yml:/skywalking/config/alarm-settings.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;11800:11800&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;12800:12800&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">SW_STORAGE:</span> <span class="string">elasticsearch</span></span><br><span class="line">      <span class="attr">SW_STORAGE_ES_CLUSTER_NODES:</span> <span class="number">192.168</span><span class="number">.31</span><span class="number">.70</span><span class="string">:9200</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">skywalking-ui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/skywalking-ui:9.0.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">skywalking-ui</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">skywalking-oap</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">skywalking-oap</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6395:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">SW_OAP_ADDRESS:</span> <span class="string">http://skywalking-oap:12800</span></span><br></pre></td></tr></table></figure>

<h3 id="告警配置"><a href="#告警配置" class="headerlink" title="告警配置"></a>告警配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Rule unique name, must be ended with `_rule`.</span></span><br><span class="line">  <span class="attr">service_resp_time_rule:</span></span><br><span class="line">    <span class="attr">metrics-name:</span> <span class="string">service_resp_time</span></span><br><span class="line">    <span class="attr">op:</span> <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">period:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">silence-period:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Response</span> <span class="string">time</span> <span class="string">of</span> <span class="string">service</span> &#123;<span class="string">name</span>&#125; <span class="string">is</span> <span class="string">more</span> <span class="string">than</span> <span class="string">1000ms</span> <span class="string">in</span> <span class="number">3</span> <span class="string">minutes</span> <span class="string">of</span> <span class="string">last</span> <span class="number">10</span> <span class="string">minutes.</span></span><br><span class="line">  <span class="attr">service_sla_rule:</span></span><br><span class="line">    <span class="comment"># Metrics value need to be long, double or int</span></span><br><span class="line">    <span class="attr">metrics-name:</span> <span class="string">service_sla</span></span><br><span class="line">    <span class="attr">op:</span> <span class="string">&quot;&lt;&quot;</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">8000</span></span><br><span class="line">    <span class="comment"># The length of time to evaluate the metrics</span></span><br><span class="line">    <span class="attr">period:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># How many times after the metrics match the condition, will trigger alarm</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># How many times of checks, the alarm keeps silence after alarm triggered, default as same as period.</span></span><br><span class="line">    <span class="attr">silence-period:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Successful</span> <span class="string">rate</span> <span class="string">of</span> <span class="string">service</span> &#123;<span class="string">name</span>&#125; <span class="string">is</span> <span class="string">lower</span> <span class="string">than</span> <span class="number">80</span><span class="string">%</span> <span class="string">in</span> <span class="number">2</span> <span class="string">minutes</span> <span class="string">of</span> <span class="string">last</span> <span class="number">10</span> <span class="string">minutes</span></span><br><span class="line">  <span class="attr">service_resp_time_percentile_rule:</span></span><br><span class="line">    <span class="comment"># Metrics value need to be long, double or int</span></span><br><span class="line">    <span class="attr">metrics-name:</span> <span class="string">service_percentile</span></span><br><span class="line">    <span class="attr">op:</span> <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">1000</span><span class="string">,1000,1000,1000,1000</span></span><br><span class="line">    <span class="attr">period:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">silence-period:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Percentile</span> <span class="string">response</span> <span class="string">time</span> <span class="string">of</span> <span class="string">service</span> &#123;<span class="string">name</span>&#125; <span class="string">alarm</span> <span class="string">in</span> <span class="number">3</span> <span class="string">minutes</span> <span class="string">of</span> <span class="string">last</span> <span class="number">10</span> <span class="string">minutes,</span> <span class="string">due</span> <span class="string">to</span> <span class="string">more</span> <span class="string">than</span> <span class="string">one</span> <span class="string">condition</span> <span class="string">of</span> <span class="string">p50</span> <span class="string">&gt;</span> <span class="number">1000</span><span class="string">,</span> <span class="string">p75</span> <span class="string">&gt;</span> <span class="number">1000</span><span class="string">,</span> <span class="string">p90</span> <span class="string">&gt;</span> <span class="number">1000</span><span class="string">,</span> <span class="string">p95</span> <span class="string">&gt;</span> <span class="number">1000</span><span class="string">,</span> <span class="string">p99</span> <span class="string">&gt;</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">service_instance_resp_time_rule:</span></span><br><span class="line">    <span class="attr">metrics-name:</span> <span class="string">service_instance_resp_time</span></span><br><span class="line">    <span class="attr">op:</span> <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">period:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">silence-period:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Response</span> <span class="string">time</span> <span class="string">of</span> <span class="string">service</span> <span class="string">instance</span> &#123;<span class="string">name</span>&#125; <span class="string">is</span> <span class="string">more</span> <span class="string">than</span> <span class="string">1000ms</span> <span class="string">in</span> <span class="number">2</span> <span class="string">minutes</span> <span class="string">of</span> <span class="string">last</span> <span class="number">10</span> <span class="string">minutes</span></span><br><span class="line">  <span class="attr">database_access_resp_time_rule:</span></span><br><span class="line">    <span class="attr">metrics-name:</span> <span class="string">database_access_resp_time</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">op:</span> <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">    <span class="attr">period:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Response</span> <span class="string">time</span> <span class="string">of</span> <span class="string">database</span> <span class="string">access</span> &#123;<span class="string">name</span>&#125; <span class="string">is</span> <span class="string">more</span> <span class="string">than</span> <span class="string">1000ms</span> <span class="string">in</span> <span class="number">2</span> <span class="string">minutes</span> <span class="string">of</span> <span class="string">last</span> <span class="number">10</span> <span class="string">minutes</span></span><br><span class="line">  <span class="attr">endpoint_relation_resp_time_rule:</span></span><br><span class="line">    <span class="attr">metrics-name:</span> <span class="string">endpoint_relation_resp_time</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">op:</span> <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">    <span class="attr">period:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Response</span> <span class="string">time</span> <span class="string">of</span> <span class="string">endpoint</span> <span class="string">relation</span> &#123;<span class="string">name</span>&#125; <span class="string">is</span> <span class="string">more</span> <span class="string">than</span> <span class="string">1000ms</span> <span class="string">in</span> <span class="number">2</span> <span class="string">minutes</span> <span class="string">of</span> <span class="string">last</span> <span class="number">10</span> <span class="string">minutes</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="comment">#  - http://127.0.0.1/notify/</span></span><br><span class="line"><span class="comment">#  - http://127.0.0.1/go-wechat/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#dingtalkHooks:</span></span><br><span class="line"><span class="comment">#  textTemplate: |-</span></span><br><span class="line"><span class="comment">#    &#123;</span></span><br><span class="line"><span class="comment">#      &quot;msgtype&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="comment">#      &quot;text&quot;: &#123;</span></span><br><span class="line"><span class="comment">#        &quot;content&quot;: &quot;Apache 告警: \n %s&quot;</span></span><br><span class="line"><span class="comment">#      &#125;</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line"><span class="comment">#  webhooks:</span></span><br><span class="line"><span class="comment">#    - url: https://oapi.dingtalk.com/robot/send?access_token=416e0d73280b480d5beb6533f475e493c6be9ca9eac85d0422718b8cfdf065e8</span></span><br><span class="line"><span class="comment">#      secret: SEC87fc4df3f024cb76e36d75cdfc090009e275b672fd6b1062e0772ad8611e5b2d</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>博客</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ 顺序消费模式下 消费端是如何保持顺序的</title>
    <url>/2023/12/13/RocketMQ%20%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F%E4%B8%8B%20%E6%B6%88%E8%B4%B9%E7%AB%AF%E6%98%AF%E5%A6%82%E4%BD%95%E4%BF%9D%E6%8C%81%E9%A1%BA%E5%BA%8F%E7%9A%84/</url>
    <content><![CDATA[<p>前置: 拉取消息的流程，并发和顺序都是一样的</p>
<p>1、将拉取到的消息（默认32条,单次拉取的条数）放入到 MessageQueue 的对应的ProcessQueue中。</p>
<span id="more"></span>



<p>2、放入消息时并修改当前ProcessQueue队列是否正在消费,刚启动时为false。注意如果当前队列放置消息时不存在消费，此时dispatchToConsume为true.</p>
<p>3、当dispatchToConsume为true时，创建一个消费消息的任务 ConsumeRequest，因为此时32条消息已经均放入该MessageQueue的Procesueue中，只需要起一个线程一直消费就行。</p>
<p>4、当前任务一直循环处理ProcessQueue中的消息（for循环）</p>




<p>5、在上报消息处理结果</p>
<ul>
<li>如果消息成功处理，则continueConsume仍为true，此任务继续循环。</li>
<li>如果消息处理失败并且当前消息没有到最大循环次数，则continueConsume设置为false跳出步骤4的循环并重新提交一个ConsumeRequest任务，延迟一秒触发。待当前任务到达时间后，继续步骤4循环</li>
<li></li>
</ul>
<h4 id="扩展："><a href="#扩展：" class="headerlink" title="扩展："></a>扩展：</h4><ul>
<li><p>并发消费模式下为什么是并发的？是因为一个消息生成一个ConsumeRequest任务并提交到线程池</p>
</li>
<li><ul>
<li>单次消息拉取会生成32个任务进行并发消费</li>
</ul>
</li>
<li></li>
</ul>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><ul>
<li><p>并发消费和顺序模式下的消息拉取机制是一样的</p>
</li>
<li><p>并发模式下 同一个队列的一条消息生成一个任务</p>
</li>
<li><ul>
<li>默认一次拉取32条，会有32个任务</li>
</ul>
</li>
<li><p>顺序模式下 同一个队列始终保持最多一个任务在运行</p>
</li>
<li><ul>
<li>synchronized (messageQueue) 对MessageQueue加锁当前队列保证同一队列串行。</li>
<li>一旦ProcessQueue中存在消息，会修改ProcessQueue的正在消费字段consuming为true，同时创建一个消息处理任务ConsumeRequest。</li>
<li>如果ProcessQueue中的消息处理完，则会修改consuming为false。</li>
<li>如果第二次拉取消息时，ProcessQueue队列中还有消息，此时不会再创建ConsumeRequest任务，但消息会继续放入ProcessQueue队列中。</li>
</ul>
</li>
<li><p>问题</p>
</li>
<li><ul>
<li>由于加锁，并发度下降。</li>
<li>如果某一个消息处理失败，在未达到最大处理次数前，会一直处理该消息，并且每次延迟1秒，也会阻塞当前MessageQueue中的后续消息消费。</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>中间件</tag>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
</search>
